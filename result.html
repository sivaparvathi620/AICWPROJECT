<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MedAI | Diagnostic Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0b1120; color: rgba(252, 249, 249, 0.96); padding: 40px; font-family: 'Inter', sans-serif; }
        .report-batch-item {
            background: #111827; border-radius: 24px; padding: 40px; 
            border: 1px solid #c6411d; margin-bottom: 40px; 
            box-shadow: 0 10px 30px rgba(173, 19, 19, 0.923);
        }
        .status-Normal { color: #10b981; }
        .status-Detected { color: #ef4444; }
        .status-Mismatch { color: #f59e0b; }
        .scan-frame { border: 3px solid #e2e6ed; border-radius: 20px; max-height: 350px; transition: 0.3s; }
        .scan-frame:hover { border-color: #3b82f6; }
        .progress { height: 12px; background: #f0f3f7; border-radius: 10px; }
        
        /* Analysis Box Styles */
        .detail-box { background: #eff1f4; border-radius: 16px; padding: 25px; border-left: 5px solid #3b82f6; color: #000; }
        .audio-section { background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed #3b82f6; }
        
        @media print {
            body { background: white !important; color: rgb(0, 0, 0) !important; padding: 0; }
            .no-print { display: none !important; }
            .report-batch-item { 
                border: 1px solid #eee !important; background: white !important; 
                color: #000 !important; box-shadow: none !important;
                page-break-after: always; margin-bottom: 0;
            }
            .detail-box { background: #f9f9f9 !important; border: 1px solid #ccc !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-5 no-print">
            <h1 class="fw-bold">AI Diagnostic Batch Report</h1>
            <p class="text-white">Review the analysis for all uploaded scans below.</p>
            <p class="small text-info">Generated: <span id="currentDate"></span></p>
        </div>

        {% for res in results %}
        {% if res.is_mismatched %}
        <div class="alert alert-warning border-warning bg-dark text-warning shadow-sm mb-4 rounded-pill text-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> The uploaded image does not statistically match a standard {{ res.label.split(' - ')[0] }} scan.
        </div>
        {% endif %}

        <div class="report-batch-item">
            <div class="row align-items-center">
                <div class="col-lg-5 text-center">
                    <img src="{{ url_for('static', filename='uploads/' + res.img) }}" class="img-fluid scan-frame shadow-lg">
                </div>
                <div class="col-lg-7 ps-lg-5 mt-4 mt-lg-0">
                    <h6 class="text-uppercase tracking-widest text-muted small fw-bold">Diagnostic Status</h6>
                    <h1 class="fw-bold mb-3 {{ 'status-Detected' if 'Detected' in res.label else 'status-Normal' if 'Normal' in res.label else 'status-Mismatch' }}">
                        {{ res.label }}
                    </h1>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>AI Confidence Score</span>
                            <span class="fw-bold text-primary">{{ res.conf }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" style="width: {{ res.conf }}%"></div>
                        </div>
                    </div>

                    <div class="audio-section no-print">
                        <p class="text-primary fw-bold mb-2"><i class="fas fa-volume-up me-2"></i>రిపోర్ట్ వినండి (Listen to Report):</p>
                        <audio controls style="width: 100%;">
                            <source src="{{ url_for('static', filename='uploads/' + res.audio) }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>

                    <div class="detail-box mt-4">
                        <h6 class="text-primary fw-bold mb-2"><i class="fas fa-microscope me-2"></i>మెడికల్ అనాలిసిస్ (Clinical Analysis):</h6>
                        <p class="mb-0 text-dark" style="line-height: 1.6; white-space: pre-wrap; font-weight: 500;">{{ res.analysis }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="d-flex gap-3 justify-content-center mt-5 no-print pb-5">
            <a href="/dashboard" class="btn btn-outline-light px-5 py-3 rounded-pill fw-bold">
                <i class="fas fa-arrow-left me-2"></i> New Analysis
            </a>
            <button onclick="window.print()" class="btn btn-primary px-5 py-3 rounded-pill fw-bold shadow-lg">
                <i class="fas fa-file-pdf me-2"></i> Download Full Report (PDF)
            </button>
        </div>
    </div>

    <script>
        document.getElementById('currentDate').innerText = new Date().toLocaleString('en-IN', { dateStyle: 'long', timeStyle: 'short' });
    </script>
</body>
</html>